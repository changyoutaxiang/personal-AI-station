# 端到端验收与测试清单

## 功能验收

### 1. 基础会话功能
- [ ] **创建新会话**
  - [ ] 访问 `/agent` 页面能正常加载
  - [ ] 点击"新建会话"按钮创建会话成功
  - [ ] 新会话自动生成标题（基于首条消息前30字符）
  - [ ] 新会话显示在侧边栏顶部

- [ ] **发送消息与接收回复**
  - [ ] 输入框能正常输入文本
  - [ ] 点击发送按钮或按Enter键发送消息
  - [ ] 消息发送后显示loading状态
  - [ ] 成功接收AI回复并显示
  - [ ] 消息按时间顺序正确排列
  - [ ] 消息支持多行文本和特殊字符

### 2. 模型切换功能
- [ ] **OpenRouter模型选择**
  - [ ] 模型选择器显示可用模型列表
  - [ ] 成功切换到不同模型（如Claude、GPT-4等）
  - [ ] 切换模型后新消息使用新模型
  - [ ] 显示当前选择的模型名称
  - [ ] 模型选择状态正确保存

- [ ] **模型调用验证**
  - [ ] 验证moonshotai/kimi-k2（默认模型）
  - [ ] 验证anthropic/claude-3-haiku（如果可用）
  - [ ] 验证openai/gpt-3.5-turbo（如果可用）
  - [ ] 不同模型返回结果符合各自特点

### 3. 提示词模板功能
- [ ] **模板选择与应用**
  - [ ] 模板选择器显示可用模板
  - [ ] 选择模板后自动应用到新会话
  - [ ] 模板内容正确显示在系统提示中
  - [ ] 支持自定义编辑模板内容

- [ ] **模板编辑与保存**
  - [ ] 可以编辑现有模板
  - [ ] 保存模板修改成功
  - [ ] 创建新的自定义模板
  - [ ] 删除不需要的模板

### 4. 对话上下文管理
- [ ] **连续对话上下文**
  - [ ] 新消息能引用前面的对话内容
  - [ ] AI回复考虑完整的对话历史
  - [ ] 上下文在会话中保持一致性
  - [ ] 切换会话时上下文正确隔离

- [ ] **历史消息限制**
  - [ ] 验证历史消息限制为最近N条（默认20条）
  - [ ] 超出限制的历史消息不会发送给AI
  - [ ] 可以调整历史消息限制数量
  - [ ] 系统提示始终包含在上下文中

### 5. 会话管理功能
- [ ] **会话列表**
  - [ ] 会话按更新时间倒序排列
  - [ ] 显示会话标题和最后更新时间
  - [ ] 当前选中会话有明显标识
  - [ ] 会话列表支持滚动查看

- [ ] **搜索与过滤**
  - [ ] 搜索框能根据标题搜索会话
  - [ ] 搜索结果实时更新
  - [ ] 支持标签过滤会话
  - [ ] 多个标签组合过滤正常工作
  - [ ] 清空搜索条件恢复完整列表

- [ ] **会话操作**
  - [ ] **重命名会话**
    - [ ] 双击会话标题进入编辑模式
    - [ ] 输入新标题并保存
    - [ ] 标题更新在界面上立即反映
  
  - [ ] **删除会话**
    - [ ] 删除会话弹出确认对话框
    - [ ] 确认删除后会话从列表移除
    - [ ] 删除当前会话时自动切换到其他会话
  
  - [ ] **导出会话**
    - [ ] 导出会话为JSON或Markdown格式
    - [ ] 导出内容包含完整的对话历史
    - [ ] 导出文件名包含会话标题和时间戳

### 6. 标签管理功能
- [ ] **标签操作**
  - [ ] 为会话添加标签
  - [ ] 删除会话标签
  - [ ] 查看所有可用标签
  - [ ] 创建新标签
  - [ ] 删除未使用的标签

## 异常场景测试

### 1. API密钥配置
- [ ] **未配置OPENROUTER_API_KEY**
  - [ ] 系统显示配置错误提示
  - [ ] 提供配置指导信息
  - [ ] 无法发送消息但其他功能正常
  - [ ] 错误信息清晰易懂

### 2. OpenRouter接口异常
- [ ] **接口超时**
  - [ ] 30秒超时后显示超时错误
  - [ ] 提供重试选项
  - [ ] 不会重复发送消息
  - [ ] 超时不影响其他功能

- [ ] **接口返回错误**
  - [ ] API密钥无效时的错误处理
  - [ ] 模型不可用时的错误提示
  - [ ] 请求频率限制的友好提示
  - [ ] 服务器错误的重试机制

### 3. 输入验证
- [ ] **超长消息输入**
  - [ ] 消息长度限制为5000字符
  - [ ] 超长输入显示警告
  - [ ] 自动截断过长内容
  - [ ] 保持界面响应性能

- [ ] **特殊内容处理**
  - [ ] 空消息无法发送
  - [ ] 纯空格消息被过滤
  - [ ] 恶意代码被安全处理
  - [ ] 特殊字符正确显示

### 4. 数据库异常
- [ ] **数据库不可用**
  - [ ] 显示数据库连接错误
  - [ ] 提供错误恢复建议
  - [ ] 不会丢失用户输入
  - [ ] 可以重新尝试连接

## 性能测试

### 1. 长对话处理
- [ ] **分页加载**
  - [ ] 长对话支持分页显示
  - [ ] 滚动加载更多历史消息
  - [ ] 加载过程流畅无卡顿
  - [ ] 内存使用保持合理

### 2. 多会话切换
- [ ] **并发会话管理**
  - [ ] 快速切换多个会话无卡顿
  - [ ] 会话状态正确保存和恢复
  - [ ] 同时打开多个会话标签正常工作
  - [ ] 会话数据正确隔离

### 3. 界面响应性能
- [ ] **UI交互流畅度**
  - [ ] 消息发送响应时间 < 100ms
  - [ ] 会话切换响应时间 < 200ms
  - [ ] 搜索结果更新时间 < 300ms
  - [ ] 页面滚动流畅无掉帧

## 测试执行步骤

### 准备工作
1. 确保已配置OPENROUTER_API_KEY环境变量
2. 启动开发服务器：`npm run dev`
3. 清理数据库或使用测试数据库
4. 准备测试数据（多种长度的消息、各种特殊字符等）

### 执行测试
1. **基础功能验证**
   ```bash
   # 访问应用
   curl http://localhost:3000/agent
   
   # 验证API端点
   curl -X POST http://localhost:3000/api/agent/conversations
   ```

2. **API接口测试**
   ```bash
   # 测试聊天接口
   curl -X POST http://localhost:3000/api/agent/chat \
     -H "Content-Type: application/json" \
     -d '{"message": "你好，这是一个测试消息"}'
   
   # 测试模型列表
   curl http://localhost:3000/api/models
   ```

3. **数据库操作验证**
   ```bash
   # 检查数据库文件
   ls -la data/digital-brain.db
   
   # 验证表结构
   sqlite3 data/digital-brain.db ".schema"
   ```

### 验证结果记录

#### 功能验收结果
- [ ] 所有基础功能正常 ✅
- [ ] 模型切换功能正常 ✅  
- [ ] 模板功能正常 ✅
- [ ] 上下文管理正常 ✅
- [ ] 会话管理功能正常 ✅
- [ ] 标签管理功能正常 ✅

#### 异常场景结果
- [ ] API密钥异常处理正常 ✅
- [ ] 接口异常处理正常 ✅
- [ ] 输入验证正常 ✅
- [ ] 数据库异常处理正常 ✅

#### 性能测试结果
- [ ] 长对话性能合格 ✅
- [ ] 多会话切换性能合格 ✅
- [ ] 界面响应性能合格 ✅

## 问题记录与修复

### 发现的问题
1. **问题描述**: [具体问题]
   - **严重程度**: 高/中/低
   - **复现步骤**: [详细步骤]
   - **预期结果**: [预期]
   - **实际结果**: [实际]
   - **修复建议**: [建议]

### 已修复问题
1. **[修复完成的问题]**
   - **修复方案**: [具体方案]
   - **测试验证**: [验证结果]

## 测试总结

### 通过率统计
- 功能验收通过率: _%
- 异常场景通过率: _%  
- 性能测试通过率: _%
- 总体通过率: _%

### 建议与改进
1. [改进建议1]
2. [改进建议2]
3. [改进建议3]

### 发布准备度
- [ ] 所有关键功能正常
- [ ] 异常处理完善
- [ ] 性能满足要求
- [ ] 文档完整
- [ ] **✅ 准备发布** / **❌ 需要修复**
